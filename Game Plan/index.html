<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Quest - Manual Calendar Import</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .player-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            opacity: 0.9;
        }

        .xp-bar {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .xp-progress {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .import-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .import-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .import-area.dragover {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .file-input {
            display: none;
        }

        .import-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
        }

        .task-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 25px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-complete {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-delete {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .task-item {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .task-item.completed {
            opacity: 0.7;
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-color: #4CAF50;
        }

        .task-item.imported {
            border-left: 5px solid #ff9800;
        }

        .task-source {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .task-source.manual {
            background: #4CAF50;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            margin-right: 60px;
        }

        .task-xp {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 12px;
        }

        .task-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .import-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-details {
            flex: 1;
        }

        .preview-time {
            color: #666;
            font-size: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(350px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .how-to-export {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .how-to-export h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .how-to-export ol {
            margin-left: 20px;
            color: #1976d2;
        }

        .how-to-export li {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .task-form {
                grid-template-columns: 1fr;
            }
            
            .player-stats {
                flex-direction: column;
                text-align: center;
            }
            
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .task-title {
                margin-right: 0;
            }
            
            .task-source {
                position: static;
                align-self: flex-start;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="player-stats">
                <div class="stat-card">
                    <h3 id="level">1</h3>
                    <p>Level</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalXp">0</h3>
                    <p>Total XP</p>
                </div>
                <div class="stat-card">
                    <h3 id="streak">0</h3>
                    <p>Day Streak</p>
                </div>
                <div class="stat-card">
                    <h3 id="completed">0</h3>
                    <p>Tasks Done</p>
                </div>
            </div>
            <div>
                <p>Progress to Level <span id="nextLevel">2</span></p>
                <div class="xp-bar">
                    <div class="xp-progress" id="xpProgress" style="width: 0%"></div>
                </div>
                <p><span id="currentXp">0</span> / <span id="xpNeeded">100</span> XP</p>
            </div>
        </div>

        <div class="import-section">
            <h3>📅 Import Calendar Events</h3>
            
            <div class="how-to-export">
                <h4>How to Export from Google Calendar:</h4>
                <ol>
                    <li>Open Google Calendar</li>
                    <li>Click the ⚙️ Settings gear → Settings</li>
                    <li>Click "Import & Export" on the left</li>
                    <li>Click "Export" - downloads a .zip file</li>
                    <li>Extract the .zip and upload any .ics file below</li>
                </ol>
                <p><strong>Other calendars:</strong> Most calendar apps can export .ics files!</p>
            </div>
            
            <div class="import-area" id="importArea">
                <p>📁 Drag & drop your .ics calendar file here</p>
                <p>or</p>
                <button class="import-btn" onclick="document.getElementById('fileInput').click()">
                    Choose Calendar File
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".ics,.ical" onchange="handleFileSelect(event)">
            </div>
            
            <div id="importPreview" class="import-preview" style="display: none;">
                <h4>Found Events - Select which to import:</h4>
                <div id="previewList"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="importSelectedEvents()">Import Selected as Tasks</button>
                    <button class="btn" onclick="selectAllEvents()">Select All</button>
                    <button class="btn" onclick="clearPreview()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('tasks')">📋 Tasks</button>
            <button class="nav-tab" onclick="switchTab('study')">⏱️ Study Timer</button>
            <button class="nav-tab" onclick="switchTab('achievements')">🏆 Achievements</button>
            <button class="nav-tab" onclick="switchTab('stats')">📊 Stats</button>
        </div>

        <div id="tasks" class="tab-content active">
            <h2>📝 Task Quest</h2>
            <div class="task-form">
                <div class="form-group">
                    <label for="taskName">Task Name</label>
                    <input type="text" id="taskName" placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label for="taskDue">Due Date</label>
                    <input type="datetime-local" id="taskDue">
                </div>
                <div class="form-group">
                    <label for="taskDifficulty">Difficulty</label>
                    <select id="taskDifficulty">
                        <option value="easy">Easy (25 XP)</option>
                        <option value="medium">Medium (50 XP)</option>
                        <option value="hard">Hard (100 XP)</option>
                        <option value="legendary">Legendary (200 XP)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addTask()">+ Add Quest</button>
            </div>
            
            <div id="taskList"></div>
        </div>

        <div id="study" class="tab-content">
            <h2>⏱️ Study Sessions</h2>
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; font-weight: bold; color: #4CAF50; margin: 20px 0;" id="timerDisplay">25:00</div>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="startTimer()">Start</button>
                    <button class="btn" onclick="pauseTimer()">Pause</button>
                    <button class="btn" onclick="resetTimer()">Reset</button>
                    <button class="btn" onclick="setTimer(25)">25min</button>
                    <button class="btn" onclick="setTimer(50)">50min</button>
                </div>
                <p>Complete study sessions to earn bonus XP!</p>
            </div>
        </div>

        <div id="achievements" class="tab-content">
            <h2>🏆 Achievement Gallery</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;" id="achievementsList"></div>
        </div>

        <div id="stats" class="tab-content">
            <h2>📊 Your Progress</h2>
            <div id="statsContent">
                <p>Tasks completed today: <strong id="todayTasks">0</strong></p>
                <p>Tasks completed this week: <strong id="weekTasks">0</strong></p>
                <p>Average XP per task: <strong id="avgXp">0</strong></p>
                <p>Most productive day: <strong id="bestDay">-</strong></p>
                <p>Study sessions completed: <strong id="studySessions">0</strong></p>
                <p>Calendar events imported: <strong id="importedEvents">0</strong></p>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Game State
        let gameState = {
            level: 1,
            totalXp: 0,
            currentXp: 0,
            xpNeeded: 100,
            streak: 0,
            tasksCompleted: 0,
            tasks: [],
            achievements: [],
            studySessions: 0,
            lastActivityDate: null,
            importedEventsCount: 0
        };

        // Preview events storage
        let previewEvents = [];

        // Timer variables
        let timerInterval = null;
        let timeLeft = 25 * 60;
        let isRunning = false;

        // Achievements definitions
        const achievementDefinitions = [
            { id: 'first_task', name: 'First Steps', desc: 'Complete your first task', icon: '🎯', requirement: 1, type: 'tasks' },
            { id: 'task_master', name: 'Task Master', desc: 'Complete 10 tasks', icon: '⭐', requirement: 10, type: 'tasks' },
            { id: 'calendar_import', name: 'Time Keeper', desc: 'Import calendar events', icon: '📅', requirement: 1, type: 'import' },
            { id: 'import_master', name: 'Import Master', desc: 'Import 10+ calendar events', icon: '🔄', requirement: 10, type: 'import' },
            { id: 'study_warrior', name: 'Study Warrior', desc: 'Complete 5 study sessions', icon: '⚔️', requirement: 5, type: 'study' },
            { id: 'level_5', name: 'Rising Star', desc: 'Reach level 5', icon: '🌟', requirement: 5, type: 'level' },
            { id: 'xp_1000', name: 'XP Master', desc: 'Earn 1000 total XP', icon: '💎', requirement: 1000, type: 'xp' }
        ];

        // File handling for calendar import
        function setupDragAndDrop() {
            const importArea = document.getElementById('importArea');
            
            importArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                importArea.classList.add('dragover');
            });
            
            importArea.addEventListener('dragleave', () => {
                importArea.classList.remove('dragover');
            });
            
            importArea.addEventListener('drop', (e) => {
                e.preventDefault();
                importArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.ics')) {
                showNotification('Please select a .ics calendar file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseICSFile(e.target.result);
                } catch (error) {
                    console.error('Error parsing calendar file:', error);
                    showNotification('Error reading calendar file. Please try again.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseICSFile(icsContent) {
            const events = [];
            const lines = icsContent.split('\n').map(line => line.trim());
            
            let currentEvent = null;
            let inEvent = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line === 'BEGIN:VEVENT') {
                    inEvent = true;
                    currentEvent = {
                        summary: '',
                        dtstart: '',
                        dtend: '',
                        description: '',
                        location: ''
                    };
                } else if (line === 'END:VEVENT' && inEvent) {
                    if (currentEvent.summary && currentEvent.dtstart) {
                        events.push({ ...currentEvent });
                    }
                    inEvent = false;
                    currentEvent = null;
                } else if (inEvent && currentEvent) {
                    if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8);
                    } else if (line.startsWith('DTSTART')) {
                        const dateMatch = line.match(/DTSTART[^:]*:(.+)/);
                        if (dateMatch) {
                            currentEvent.dtstart = parseICSDate(dateMatch[1]);
                        }
                    } else if (line.startsWith('DTEND')) {
                        const dateMatch = line.match(/DTEND[^:]*:(.+)/);
                        if (dateMatch) {
                            currentEvent.dtend = parseICSDate(dateMatch[1]);
                        }
                    } else if (line.startsWith('DESCRIPTION:')) {
                        currentEvent.description = line.substring(12);
                    } else if (line.startsWith('LOCATION:')) {
                        currentEvent.location = line.substring(9);
                    }
                }
            }
            
            if (events.length === 0) {
                showNotification('No events found in calendar file', 'error');
                return;
            }
            
            // Filter future evnts only
            const now = new Date();
            const futureEvents = events.filter(event => {
                const eventDate = new Date(event.dtstart);
                return eventDate > now;
            }).sort((a, b) => new Date(a.dtstart) - new Date(b.dtstart));
            
            if (futureEvents.length === 0) {
                showNotification('No upcoming events found in calendar file', 'error');
                return;
            }
            
            previewEvents = futureEvents.slice(0, 20); // Limit to 20 events
            showPreview();
        }

        function parseICSDate(dateStr) {
            // Handle different ICS date formats
            if (dateStr.includes('T')) {
                
                const cleanDate = dateStr.replace(/[TZ]/g, '').replace(/[-:]/g, '');
                const year = cleanDate.substring(0, 4);
                const month = cleanDate.substring(4, 6);
                const day = cleanDate.substring(6, 8);
                const hour = cleanDate.substring(8, 10) || '00';
                const minute = cleanDate.substring(10, 12) || '00';
                
                return new Date(year, month - 1, day, hour, minute).toISOString();
            } else {
                // All-day event format: 20241201
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                
                return new Date(year, month - 1, day).toISOString();
            }
        }

        function showPreview() {
            const previewDiv = document.getElementById('importPreview');
            const previewList = document.getElementById('previewList');
            
            previewList.innerHTML = '';
            
            previewEvents.forEach((event, index) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'preview-item';
                
                const startDate = new Date(event.dtstart);
                const endDate = event.dtend ? new Date(event.dtend) : null;
                const duration = endDate ? Math.round((endDate - startDate) / (1000 * 60)) : 0;
                
                // Determine difficulty based on duration
                let difficulty, xp;
                if (duration <= 30) {
                    difficulty = 'Easy';
                    xp = 25;
                } else if (duration <= 90) {
                    difficulty = 'Medium';
                    xp = 50;
                } else if (duration <= 180) {
                    difficulty = 'Hard';
                    xp = 100;
                } else {
                    difficulty = 'Legendary';
                    xp = 200;
                }
                
                eventDiv.innerHTML = `
                    <div>
                        <input type="checkbox" id="event-${index}" checked>
                        <label for="event-${index}" style="margin-left: 8px;">
                            <strong>${event.summary}</strong>
                            <div class="preview-time">${startDate.toLocaleString()}</div>
                            ${event.location ? `<div class="preview-time">📍 ${event.location}</div>` : ''}
                            <div class="preview-time">${difficulty} • ${duration}min • +${xp} XP</div>
                        </label>
                    </div>
                `;
                
                previewList.appendChild(eventDiv);
            });
            
            previewDiv.style.display = 'block';
            showNotification(`Found ${previewEvents.length} upcoming events!`);
        }

        function selectAllEvents() {
            const checkboxes = document.querySelectorAll('#previewList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        function importSelectedEvents() {
            const checkboxes = document.querySelectorAll('#previewList input[type="checkbox"]');
            let importedCount = 0;
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    const event = previewEvents[index];
                    const startDate = new Date(event.dtstart);
                    const endDate = event.dtend ? new Date(event.dtend) : null;
                    const duration = endDate ? Math.round((endDate - startDate) / (1000 * 60)) : 60;
                    
                    // Determine difficulty and XP
                    let difficulty, xp;
                    if (duration <= 30) {
                        difficulty = 'easy';
                        xp = 25;
                    } else if (duration <= 90) {
                        difficulty = 'medium';
                        xp = 50;
                    } else if (duration <= 180) {
                        difficulty = 'hard';
                        xp = 100;
                    } else {
                        difficulty = 'legendary';
                        xp = 200;
                    }
                    
                    const task = {
                        id: Date.now() + Math.random(),
                        name: event.summary,
                        due: event.dtstart,
                        difficulty,
                        xp,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        source: 'imported',
                        location: event.location,
                        description: event.description
                    };
                    
                    gameState.tasks.push(task);
                    importedCount++;
                }
            });
            
            gameState.importedEventsCount += importedCount;
            clearPreview();
            saveGameState();
            updateDisplay();
            
            showNotification(`📅 Imported ${importedCount} events as tasks!`);
            checkAchievements();
            
            // Switch to tasks tab
            switchTab('tasks');
        }

        function clearPreview() {
            document.getElementById('importPreview').style.display = 'none';
            previewEvents = [];
            document.getElementById('fileInput').value = '';
        }

        // Load game state
        function loadGameState() {
            const saved = localStorage.getItem('collegeQuestImportState');
            if (saved) {
                gameState = { ...gameState, ...JSON.parse(saved) };
            }
            updateDisplay();
        }

        // Save game state
        function saveGameState() {
            localStorage.setItem('collegeQuestImportState', JSON.stringify(gameState));
        }

        // Update display
        function updateDisplay() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('totalXp').textContent = gameState.totalXp;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('completed').textContent = gameState.tasksCompleted;
            document.getElementById('nextLevel').textContent = gameState.level + 1;
            document.getElementById('currentXp').textContent = gameState.currentXp;
            document.getElementById('xpNeeded').textContent = gameState.xpNeeded;
            
            const progressPercent = (gameState.currentXp / gameState.xpNeeded) * 100;
            document.getElementById('xpProgress').style.width = progressPercent + '%';
            
            updateTasksList();
            updateAchievements();
            updateStats();
        }

        // Add XP and check for level up
        function addXP(amount) {
            gameState.totalXp += amount;
            gameState.currentXp += amount;
            
            if (gameState.currentXp >= gameState.xpNeeded) {
                levelUp();
            }
            
            saveGameState();
            updateDisplay();
        }

        // Level up
        function levelUp() {
            gameState.currentXp -= gameState.xpNeeded;
            gameState.level++;
            gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.5);
            
            showNotification(`🎉 Level Up! You're now level ${gameState.level}!`);
            checkAchievements();
        }

        // Add task
        function addTask() {
            const name = document.getElementById('taskName').value.trim();
            const due = document.getElementById('taskDue').value;
            const difficulty = document.getElementById('taskDifficulty').value;
            
            if (!name) {
                alert('Please enter a task name');
                return;
            }
            
            const xpValues = {
                easy: 25,
                medium: 50,
                hard: 100,
                legendary: 200
            };
            
            const task = {
                id: Date.now(),
                name,
                due,
                difficulty,
                xp: xpValues[difficulty],
                completed: false,
                createdAt: new Date().toISOString(),
                source: 'manual'
            };
            
            gameState.tasks.push(task);
            
            // Clear form
            document.getElementById('taskName').value = '';
            document.getElementById('taskDue').value = '';
            document.getElementById('taskDifficulty').value = 'easy';
            
            saveGameState();
            updateDisplay();
            showNotification('📋 New quest added!');
        }

        // Complete task
        function completeTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                task.completed = true;
                task.completedAt = new Date().toISOString();
                
                addXP(task.xp);
                gameState.tasksCompleted++;
                updateStreak();
                
                // Bonus XP for imported tasks
                if (task.source === 'imported') {
                    addXP(10);
                    showNotification(`✅ Imported quest completed! +${task.xp + 10} XP (bonus!)`);
                } else {
                    showNotification(`✅ Quest completed! +${task.xp} XP`);
                }
                
                checkAchievements();
            }
        }

        // Delete task
        function deleteTask(taskId) {
            gameState.tasks = gameState.tasks.filter(t => t.id !== taskId);
            saveGameState();
            updateDisplay();
        }

        // Update tasks list
        function updateTasksList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            // Sort tasks: incomplete first, then by due date
            const sortedTasks = gameState.tasks.sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                if (a.due && b.due) {
                    return new Date(a.due) - new Date(b.due);
                }
                return 0;
            });
            
            sortedTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${task.completed ? 'completed' : ''} ${task.source === 'imported' ? 'imported' : ''}`;
                
                const dueText = task.due ? new Date(task.due).toLocaleString() : 'No due date';
                const difficultyEmoji = {
                    easy: '🟢',
                    medium: '🟡',
                    hard: '🔴',
                    legendary: '🟣'
                };
                
                taskDiv.innerHTML = `
                    <div class="task-source ${task.source}">${task.source === 'imported' ? '📅 IMPORTED' : '✏️ MANUAL'}</div>
                    <div class="task-header">
                        <div class="task-title">${task.name}</div>
                        <div class="task-xp">+${task.xp} XP</div>
                    </div>
                    <div class="task-details">
                        <span>${difficultyEmoji[task.difficulty]} ${task.difficulty.charAt(0).toUpperCase() + task.difficulty.slice(1)}</span>
                        <span>Due: ${dueText}</span>
                    </div>
                    ${task.location ? `<div style="color: #666; font-size: 12px; margin-bottom: 10px;">📍 ${task.location}</div>` : ''}
                    ${task.description ? `<div style="color: #666; font-size: 12px; margin-bottom: 10px;">${task.description}</div>` : ''}
                    <div class="task-actions">
                        ${!task.completed ? `<button class="btn btn-complete" onclick="completeTask(${task.id})">Complete</button>` : '<span>✅ Completed</span>'}
                        <button class="btn btn-delete" onclick="deleteTask(${task.id})">Delete</button>
                    </div>
                `;
                
                taskList.appendChild(taskDiv);
            });
        }

        // Update streak
        function updateStreak() {
            const today = new Date().toDateString();
            const lastActivity = gameState.lastActivityDate;
            
            if (lastActivity === today) {
                return;
            }
            
            if (lastActivity) {
                const lastDate = new Date(lastActivity);
                const todayDate = new Date(today);
                const diffTime = todayDate - lastDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    gameState.streak++;
                } else if (diffDays > 1) {
                    gameState.streak = 1;
                }
            } else {
                gameState.streak = 1;
            }
            
            gameState.lastActivityDate = today;
            saveGameState();
        }

        // Timer functions
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        completeStudySession();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = 25 * 60;
            updateTimerDisplay();
        }

        function setTimer(minutes) {
            pauseTimer();
            timeLeft = minutes * 60;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function completeStudySession() {
            pauseTimer();
            gameState.studySessions++;
            addXP(30);
            showNotification('🎓 Study session complete! +30 XP');
            resetTimer();
            checkAchievements();
        }

        // Achievements
        function updateAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            
            achievementDefinitions.forEach(achievement => {
                const isUnlocked = gameState.achievements.includes(achievement.id);
                const card = document.createElement('div');
                card.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    text-align: center;
                    transition: all 0.3s ease;
                    border: 3px solid ${isUnlocked ? '#4CAF50' : 'transparent'};
                    opacity: ${isUnlocked ? '1' : '0.5'};
                    box-shadow: ${isUnlocked ? '0 0 20px rgba(76, 175, 80, 0.3)' : 'none'};
                `;
                
                card.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">${achievement.icon}</div>
                    <h3>${achievement.name}</h3>
                    <p>${achievement.desc}</p>
                    ${isUnlocked ? '<p style="color: #4CAF50; font-weight: bold;">✓ UNLOCKED</p>' : ''}
                `;
                
                achievementsList.appendChild(card);
            });
        }

        function checkAchievements() {
            achievementDefinitions.forEach(achievement => {
                if (gameState.achievements.includes(achievement.id)) return;
                
                let unlocked = false;
                
                switch (achievement.type) {
                    case 'tasks':
                        unlocked = gameState.tasksCompleted >= achievement.requirement;
                        break;
                    case 'import':
                        if (achievement.requirement === 1) {
                            unlocked = gameState.importedEventsCount > 0;
                        } else {
                            unlocked = gameState.importedEventsCount >= achievement.requirement;
                        }
                        break;
                    case 'study':
                        unlocked = gameState.studySessions >= achievement.requirement;
                        break;
                    case 'level':
                        unlocked = gameState.level >= achievement.requirement;
                        break;
                    case 'xp':
                        unlocked = gameState.totalXp >= achievement.requirement;
                        break;
                }
                
                if (unlocked) {
                    gameState.achievements.push(achievement.id);
                    showNotification(`🏆 Achievement Unlocked: ${achievement.name}!`);
                    addXP(50);
                }
            });
            
            saveGameState();
            updateDisplay();
        }

        // Stats
        function updateStats() {
            const today = new Date().toDateString();
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            
            const todayTasks = gameState.tasks.filter(t => 
                t.completed && new Date(t.completedAt).toDateString() === today
            ).length;
            
            const weekTasks = gameState.tasks.filter(t => 
                t.completed && new Date(t.completedAt) >= weekAgo
            ).length;
            
            const avgXp = gameState.tasksCompleted > 0 ? 
                Math.round(gameState.totalXp / gameState.tasksCompleted) : 0;
            
            document.getElementById('todayTasks').textContent = todayTasks;
            document.getElementById('weekTasks').textContent = weekTasks;
            document.getElementById('avgXp').textContent = avgXp;
            document.getElementById('bestDay').textContent = gameState.streak > 0 ? 'Today!' : 'Start completing tasks!';
            document.getElementById('studySessions').textContent = gameState.studySessions;
            document.getElementById('importedEvents').textContent = gameState.importedEventsCount;
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadGameState();
            setupDragAndDrop();
            
            // Set current datetime as default for new tasks
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('taskDue').value = localDateTime;
        });
    </script>
</body>
</html>